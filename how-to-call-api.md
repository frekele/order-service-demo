# How to Call the Order Service API with Postman

This guide provides practical examples of how to interact with all endpoints of the Order Service API using Postman.

## Prerequisites

1.  **The application must be running:** Make sure you have started the infrastructure with `docker compose up -d` and the main application with `mvn spring-boot:run` as described in the main `README.md`.
2.  **Postman:** You need to have [Postman](https://www.postman.com/downloads/) installed.

The base URL for all requests will be `http://localhost:8080`.

## API Calls

### 1. Create a New Order (Happy Path)

This call simulates **Product A** sending a new order to the service.

* **Method:** `POST`
* **URL:** `http://localhost:8080/orders`
* **Headers:**
    * `Content-Type`: `application/json`
* **Body:**
    ```json
    {
      "externalOrderId": "EXT-001",
      "items": [
        {
          "productCode": "P001",
          "productName": "Product A",
          "quantity": 2,
          "unitPrice": 25.50
        },
        {
          "productCode": "P002",
          "productName": "Product B",
          "quantity": 1,
          "unitPrice": 49.99
        }
      ]
    }
    ```
* **What to Expect:**
    * **Status:** `201 Created`
    * **Headers:** A `Location` header pointing to the newly created resource (e.g., `/orders/c7e9b4c0-...`).
    * **Side Effects:** A message will be published to RabbitMQ. After a few moments, a new document will appear in your `orders` collection in MongoDB, and a notification will be sent to your Webhook.site URL.

### 2. Create a Duplicate Order (Error Scenario)

This tests the duplicate check.

* **Method:** `POST`
* **URL:** `http://localhost:8080/orders`
* **Body:** Use the **exact same body** as the previous call, with the same `externalOrderId`.
* **What to Expect:**
    * **Status:** `409 Conflict`
    * **Body:** A JSON error response indicating that the order with that external ID already exists, generated by your `GlobalExceptionHandler`.

### 3. Create an Invalid Order (Error Scenario)

This tests the API's validation.

* **Method:** `POST`
* **URL:** `http://localhost:8080/orders`
* **Body:** A JSON body missing a required field, such as `externalOrderId`.
    ```json
    {
      "items": [
        {
          "productCode": "P001",
          "productName": "Product A",
          "quantity": 1,
          "unitPrice": 10.00
        }
      ]
    }
    ```
* **What to Expect:**
    * **Status:** `400 Bad Request`
    * **Body:** A JSON error response with a message detailing the validation failure.

### 4. Query an Order by ID

**Prerequisite:** You need an `id` from a previously created order. To get one:
1.  Run the "Create a New Order" call.
2.  Access MongoDB (using MongoDB Compass).
3.  Open the `orders` collection in the `orderdb` database.
4.  Copy the `_id` value of a document (e.g., `c7e9b4c0-7b9a-4b9e-8e0a-1b2c3d4e5f6a`).

* **Method:** `GET`
* **URL:** `http://localhost:8080/orders/{id}`
    * **Note:** Replace `{id}` with the `_id` you copied from MongoDB.
    * Example: `http://localhost:8080/orders/c7e9b4c0-7b9a-4b9e-8e0a-1b2c3d4e5f6a`
* **What to Expect:**
    * **Status:** `200 OK`
    * **Body:** The complete JSON of the `OrderResponse` object, including its `status`, `totalValue`, etc.

### 5. List Orders with Filters

* **Method:** `GET`
* **URL:** `http://localhost:8080/orders`
* **Example Variations:**
    * **No filters (with default pagination):** `http://localhost:8080/orders`
    * **Filter by status:** `http://localhost:8080/orders?status=COMPLETED`
    * **Filter by external ID:** `http://localhost:8080/orders?externalOrderId=EXT-001`
    * **Custom pagination:** `http://localhost:8080/orders?page=0&size=5`
* **What to Expect:**
    * **Status:** `200 OK`
    * **Body:** An `OrderListPage` object with the list of orders and pagination metadata.

### 6. Cancel an Order

* **Method:** `DELETE`
* **URL:** `http://localhost:8080/orders/{id}/cancel`
    * **Note:** Replace `{id}` with the ID of an order that is in the `RECEIVED` or `PROCESSING` state.
* **What to Expect:**
    * **Status:** `204 No Content`
    * **Side Effects:** The `status` of the order in MongoDB will be changed to `CANCELLED`.

### 7. Retry a Failed Order

To test this, you first need to simulate a failure. An easy way is to:
1.  Go to `application.properties` and change the `external.product-b.webhook-url` to an invalid URL (e.g., `http://localhost:9999/invalid`).
2.  Restart the application and create a new order. The `OrderEventListener` will fail to send the notification, and the order's status will be set to `FAILED`.
3.  Copy the `id` of this `FAILED` order from MongoDB.
4.  (Optional) Restore the correct webhook URL and restart the app again.

* **Method:** `POST`
* **URL:** `http://localhost:8080/orders/{id}/retry`
    * **Note:** Replace `{id}` with the ID of the `FAILED` order.
* **What to Expect:**
    * **Status:** `202 Accepted`
    * **Side Effects:** The order's `status` in MongoDB will change back to `RECEIVED`, and a new message will be published to RabbitMQ to be processed again.